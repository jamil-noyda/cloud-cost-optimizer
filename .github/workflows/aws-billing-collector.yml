name: AWS Billing Data Collector

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run the billing collection'
        required: false
        default: 'false'

env:
  AWS_REGION: us-east-1  # Billing metrics are only available in us-east-1
  PROMETHEUS_PUSHGATEWAY_URL: ${{ secrets.PROMETHEUS_PUSHGATEWAY_URL }}

jobs:
  collect-billing-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication with AWS

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: GitHubActions-BillingCollector
        aws-region: ${{ env.AWS_REGION }}
        # Alternative: use access keys if OIDC is not set up
        # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        # aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Test AWS connection
      run: |
        aws sts get-caller-identity
        echo "AWS connection successful"

    - name: Collect AWS billing data
      run: |
        python scripts/collect_billing_data.py
      env:
        PROMETHEUS_PUSHGATEWAY_URL: ${{ env.PROMETHEUS_PUSHGATEWAY_URL }}
        PROMETHEUS_JOB_NAME: aws-billing-collector
        AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    - name: Push metrics to Prometheus
      run: |
        python scripts/push_to_prometheus.py
      env:
        PROMETHEUS_PUSHGATEWAY_URL: ${{ env.PROMETHEUS_PUSHGATEWAY_URL }}
        PROMETHEUS_JOB_NAME: aws-billing-collector

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: billing-data-${{ github.run_number }}
        path: |
          data/
          logs/
        retention-days: 7

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: collect-billing-data
    if: failure()
    
    steps:
    - name: Send notification on failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#alerts'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: "AWS Billing data collection failed in ${{ github.repository }}"
      if: env.SLACK_WEBHOOK_URL != ''